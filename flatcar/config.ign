{
  "ignition": {
    "version": "3.4.0"
  },
  "passwd": {
    "groups": [
      {
        "gid": 53,
        "name": "nameserver"
      }
    ],
    "users": [
      {
        "name": "core",
        "sshAuthorizedKeys": [
          "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCnCrYODG3Irtzcrixc4dLMVDYZVzU6RknXGULAq8D2QyjUVRHpwiUyg7LaoUu9sejQKNWAs57wCqiZ2fgYbYrejeVlW/fiP5cKGD/E8J+ul5K8wmtZsDEwUzQE0t40dqbdRHzo7uOYEu2acOrvs0giSD9zjo+hbgsLZ4DJtRWZ6REzYJb87jmm8ug4LUihBvCrLoiIC5RIchQRn1wkaYvqJ7f1MJDuPP0OdUDnhrnRJ0AubhPj16rJ7K1vcQqBV7GgjbrXAsGGJYpdISdSC7+tL+TWaznzSPESm9HGhN/AGpcKu0g8Efu5FOjlCXvC//kdkeBzW8ePmj47KqSZxOIgAtqUW/JGIzKgqiD0ZWOMGEyTp8CHlYTV3ZcLPbXTvD0GHWitz96y5DtUjY8lUrOHxwUdIFQOPsdo+eSKiECGBdk6/LXtbE3zb2NN+GDYfYP/m3NvXvyDnkPDt25n/jr3MG64jbX18YbekgaDdniZn3PaNfsrDvMtNY6aSMYuckM="
        ]
      },
      {
        "homeDir": "/var/tmp",
        "name": "nameserver",
        "noCreateHome": true,
        "primaryGroup": "nameserver",
        "shell": "/usr/sbin/nologin",
        "uid": 53
      }
    ]
  },
  "storage": {
    "directories": [
      {
        "path": "/etc/sidn",
        "mode": 493
      },
      {
        "group": {
          "name": "nameserver"
        },
        "path": "/var/tmp/acme_0",
        "user": {
          "name": "nameserver"
        },
        "mode": 493
      },
      {
        "group": {
          "name": "nameserver"
        },
        "path": "/var/tmp/acme_1",
        "user": {
          "name": "nameserver"
        },
        "mode": 493
      },
      {
        "group": {
          "name": "nameserver"
        },
        "path": "/var/tmp/blah_0",
        "user": {
          "name": "nameserver"
        },
        "mode": 493
      }
    ],
    "disks": [
      {
        "device": "/dev/sda",
        "partitions": [
          {
            "label": "raid.1.1",
            "number": 1,
            "sizeMiB": 0,
            "startMiB": 0
          }
        ],
        "wipeTable": true
      },
      {
        "device": "/dev/sdb",
        "partitions": [
          {
            "label": "raid.1.2",
            "number": 1,
            "sizeMiB": 0,
            "startMiB": 0
          }
        ],
        "wipeTable": true
      }
    ],
    "files": [
      {
        "path": "/etc/ssh/sshd_config",
        "contents": {
          "source": "https://ipxe.thomasvdw.com/examples/sshd_config"
        }
      },
      {
        "path": "/etc/sidn/node_data.json",
        "contents": {
          "source": "https://ipxe.thomasvdw.com/examples/node_data.json"
        },
        "mode": 420
      },
      {
        "group": {
          "name": "nameserver"
        },
        "path": "/var/tmp/acme_0/example.com.zone",
        "user": {
          "name": "nameserver"
        },
        "contents": {
          "source": "https://ipxe.thomasvdw.com/examples/example.com.zone"
        },
        "mode": 420
      },
      {
        "group": {
          "name": "nameserver"
        },
        "path": "/var/tmp/acme_0/example.org.zone",
        "user": {
          "name": "nameserver"
        },
        "contents": {
          "source": "https://ipxe.thomasvdw.com/examples/example.org.zone"
        },
        "mode": 420
      },
      {
        "group": {
          "name": "nameserver"
        },
        "path": "/var/tmp/acme_1/example.net.zone",
        "user": {
          "name": "nameserver"
        },
        "contents": {
          "source": "https://ipxe.thomasvdw.com/examples/example.net.zone"
        },
        "mode": 420
      },
      {
        "group": {
          "name": "nameserver"
        },
        "path": "/var/tmp/blah_0/example.nl.zone",
        "user": {
          "name": "nameserver"
        },
        "contents": {
          "source": "https://ipxe.thomasvdw.com/examples/example.nl.zone"
        },
        "mode": 420
      },
      {
        "path": "/etc/systemd/network/10-dummy0.netdev",
        "contents": {
          "compression": "",
          "source": "data:,%5BNetDev%5D%0AName%3Ddummy0%0AKind%3Ddummy%0A"
        }
      },
      {
        "path": "/etc/systemd/network/20-dummy0.network",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/4r2TSxJzojl8kvMTbVNKc3NrTTg4or2Sy0pzy/KjuVyTEkpSi0utjW0NNEz0DM20DPSNzKBixoZGBhamZlbWBklW1kZWppYGVgZG1gZ6ZtYYGo0JqzRGKtGE8IaTUAaAQEAAP//s2ndacoAAAA="
        },
        "mode": 420
      },
      {
        "path": "/deploy-test/deploy-test.py",
        "contents": {
          "source": "https://ipxe.thomasvdw.com/deploy-test/deploy-test.py"
        },
        "mode": 420
      }
    ],
    "filesystems": [
      {
        "device": "/dev/md/data",
        "format": "ext4",
        "label": "DATA",
        "path": "/var/lib/data"
      }
    ],
    "raid": [
      {
        "devices": [
          "/dev/disk/by-partlabel/raid.1.1",
          "/dev/disk/by-partlabel/raid.1.2"
        ],
        "level": "raid1",
        "name": "data"
      }
    ]
  },
  "systemd": {
    "units": [
      {
        "enabled": true,
        "name": "sshd.service"
      },
      {
        "mask": true,
        "name": "sshd.socket"
      },
      {
        "contents": "[Unit]\nDescription=Remount etc read-only\n\n[Service]\nType=oneshot\nExecStart=/usr/bin/mount -o remount,ro /etc\n\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "lock-etc.service"
      },
      {
        "contents": "[Mount]\nWhat=/dev/md/data\nWhere=/var/lib/data\nType=ext4\n\n[Install]\nWantedBy=local-fs.target\n",
        "enabled": true,
        "name": "var-lib-data.mount"
      },
      {
        "enabled": true,
        "name": "docker.service"
      },
      {
        "contents": "[Unit]\nDescription=Docker container running Knot\nAfter=docker.service\nRequires=docker.service\n\n[Service]\nType=exec\nTimeoutStartSec=0\nExecStartPre=-/usr/bin/docker rm --force nameserver-%i\nExecStartPre=-mkdir -p /var/tmp/%i/rundir\nExecStartPre=-chown 53:53 /var/tmp/%i/rundir\nExecStart=/usr/bin/docker run --network host --name nameserver-%i -v /etc/sidn:/etc/sidn:ro -v /var/tmp/%i/rundir:/rundir -v /var/tmp/%i:/storage -e CUSTOMER_GROUP=%i jeroenbulten/knot:sidn knotd\nExecStop=/usr/bin/docker stop nameserver-%i\nRestart=always\nRestartSec=60\nRestartPreventExitStatus=1\n\n[Install]\nWantedBy=multi-user.target \n",
        "name": "nameserver-@.service"
      },
      {
        "enabled": true,
        "name": "nameserver-@acme_0.service"
      },
      {
        "enabled": true,
        "name": "nameserver-@acme_1.service"
      },
      {
        "enabled": true,
        "name": "nameserver-@blah_0.service"
      },
      {
        "contents": "[Unit]\nDescription=Deploy test\nAfter=nameserver-@.service\nRequires=docker.service\n\n[Service]\nType=oneshot\nExecStartPre=-/usr/bin/docker rm --force deploy-test\nExecStart=/usr/bin/docker run --name deploy-test --pull always --log-driver=journald --net host -v /deploy-test:/deploy-test:ro -v /etc/sidn:/etc/sidn:ro jeroenbulten/deploy-test python /deploy-test/deploy-test.py\n\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "deploy-test.service"
      }
    ]
  }
}
